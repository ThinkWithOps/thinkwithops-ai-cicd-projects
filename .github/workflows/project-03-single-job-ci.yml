name: CI - Single Job with Slack Alerts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Run build step
        run: |
          set -o pipefail
          {
            echo "Building application..."
            # Fail 30% of the time with a real error
            if [ $((RANDOM % 10)) -lt 3 ]; then
              echo "ERROR: npm ERR! Missing package.json in root directory"
              exit 1
            else
              echo "Build succeeded."
              exit 0
            fi
          } 2>&1 | tee build.log

      - name: Report Success to Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status success \
            --job "build" \
            --log "Build completed successfully on ${{ github.ref_name }}." \
            --webhook-url "$SLACK_WEBHOOK_URL"

      - name: Report Failure to Slack
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          LOG_MSG="$(cat build.log)"
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status failure \
            --job "build" \
            --log "$LOG_MSG" \
            --webhook-url "$SLACK_WEBHOOK_URL"
