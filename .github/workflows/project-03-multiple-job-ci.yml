name: CI - Multi-Job with Slack Alerts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Build application
        run: |
          set -o pipefail
          {
            echo "Building app..."
            if [ $((RANDOM % 4)) -eq 0 ]; then
              echo "ERROR: webpack failed - config file not found"
              exit 1
            else
              echo "Build succeeded."
              exit 0
            fi
          } 2>&1 | tee build.log

      - name: Report Build Success to Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status success \
            --job "build-app" \
            --log "Application built successfully." \
            --webhook-url "$SLACK_WEBHOOK_URL"

      - name: Report Build Failure to Slack
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          LOG_MSG="$(cat build.log)"
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status failure \
            --job "build-app" \
            --log "$LOG_MSG" \
            --webhook-url "$SLACK_WEBHOOK_URL"

  run-tests:
    needs: build-app
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests pytest

      - name: Run unit tests
        run: |
          set -o pipefail
          {
            echo "Running tests..."
            if [ $((RANDOM % 3)) -eq 0 ]; then
              echo "ERROR: test_auth.py failed - AssertionError: expected True, got False"
              exit 1
            else
              echo "All tests passed!"
              exit 0
            fi
          } 2>&1 | tee test.log

      - name: Report Test Success to Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status success \
            --job "run-tests" \
            --log "All unit tests passed." \
            --webhook-url "$SLACK_WEBHOOK_URL"

      - name: Report Test Failure to Slack
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          LOG_MSG="$(cat test.log)"
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status failure \
            --job "run-tests" \
            --log "$LOG_MSG" \
            --webhook-url "$SLACK_WEBHOOK_URL"
