name: CI - Multi-Job with Slack Alerts

on:
  push:
    branches: [ main ]
    paths:
      - "project-03_slack-pipeline-reporter/**"
      - ".github/workflows/project-03-multiple-job-ci.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "project-03_slack-pipeline-reporter/**"
      - ".github/workflows/project-03-multiple-job-ci.yml"

jobs:
  build-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Build application
        run: |
          set -o pipefail
          {
            echo "Building app..."
            echo "Build succeeded."
            exit 0
          } 2>&1 | tee build.log

      - name: Report Build Success to Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status success \
            --job "build-app" \
            --log "Application built successfully." \
            --webhook-url "$SLACK_WEBHOOK_URL"

      - name: Report Build Failure to Slack
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          LOG_MSG="$(cat build.log)"
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status failure \
            --job "build-app" \
            --log "$LOG_MSG" \
            --webhook-url "$SLACK_WEBHOOK_URL"

  run-tests:
    needs: build-app
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests pytest

      - name: Run unit tests
        run: |
          set -o pipefail
          {
            echo "Running tests..."
            echo "All tests passed!"
            exit 0
          } 2>&1 | tee test.log

      - name: Report Test Success to Slack
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status success \
            --job "run-tests" \
            --log "All unit tests passed." \
            --webhook-url "$SLACK_WEBHOOK_URL"

      - name: Report Test Failure to Slack
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          LOG_MSG="$(cat test.log)"
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status failure \
            --job "run-tests" \
            --log "$LOG_MSG" \
            --webhook-url "$SLACK_WEBHOOK_URL"

  fail-demo:
    needs: run-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Deliberate failure
        run: |
          set -o pipefail
          {
            echo "ERROR: npm ERR! Missing package.json in root directory"
            exit 1
          } 2>&1 | tee fail.log

      - name: Report Failure to Slack
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          LOG_MSG="$(cat fail.log)"
          python project-03_slack-pipeline-reporter/report_to_slack.py \
            --status failure \
            --job "fail-demo" \
            --log "$LOG_MSG" \
            --webhook-url "$SLACK_WEBHOOK_URL"
